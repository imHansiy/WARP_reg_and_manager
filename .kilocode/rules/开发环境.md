# 开发环境与经验总结

更新时间：2025-10-26

本项目是一个 Warp 账户注册器与管理器，使用 Python + PyQt5 构建 GUI，整合 mitmproxy 实现请求拦截与自动切换。

- 运行与启动
  - 建议使用 `.venv` 虚拟环境：
    ```bash
    python -m venv .venv
    # Windows
    .venv\Scripts\activate
    # macOS/Linux
    source .venv/bin/activate
    ```
  - 启动命令：
    ```bash
    .venv/Scripts/python main.py
    ```

- 依赖与工具
  - GUI：PyQt5
  - 代理：mitmproxy 11（mitmdump）
  - 浏览器自动化（可选）：Playwright + playwright_stealth + fingerprint-chromium
  - 网络：requests / curl_cffi

- 代理与拦截（mitmproxy）
  - 自动端口选择（默认 18080）、证书生成与自动安装、内嵌日志控制台。
  - 降噪：flow_detail=0、console_eventlog_verbosity=error、connection_strategy=lazy、http2=false。
  - 忽略 TLS 解密域：*.googleapis.com、*.gstatic.com、*.google.com；静默 cloudflareclient、baidupcs 等非 Warp 相关域。
  - 支持“仅 Warp”模式（可开关），非 Warp 流量透传且不打印，减少与 VPN/系统流量冲突。

- Warp 集成与自动化
  - 请求注入：自动为 app.warp.dev 注入最新 Bearer Token 与随机 x-warp-experiment-id。
  - 一键启动：刷新限制 → 选择可用账户（优先剩余额度最多）→ 启动代理并激活 → 自动启动 Warp.exe（为进程注入 http/https 代理变量）。
  - 自动轮换：当前账户达到限制（used >= total）后，自动切换到下一个可用账户，并将已用尽账户从数据库移除；状态栏 toast 提示。
  - 剪贴板自动入库：基于 Qt 的 clipboard dataChanged 事件，复制包含 email 与 stsTokenManager 的 JSON 即自动入库；已存在邮箱自动忽略并提示。

- UI 与日志
  - 日志面板默认过滤“warp.dev”，可按级别与关键字二次过滤；支持复制与清空。
  - 表格首列指示当前账户；右键菜单提供激活/停用/删除等；顶部采用“一键启动”替代逐行按钮。
  - 移除作者外链，界面更简洁统一。

- 稳定性与兼容性
  - 令牌刷新与限额查询走直连（verify=false），避免被代理影响结果。
  - 事件驱动的剪贴板监听替代轮询，资源占用更低、响应更及时。
  - 端口检测/占用释放、Windows 证书诊断与安装流程完备。

- 调试与诊断
  - debug.txt 或 WARP_PROXY_VERBOSE=1 开启详细日志；WARP_PROXY_WARP_ONLY 控制“仅 Warp”模式。
  - 常见错误链路（证书/端口/依赖）均有日志与 UI 提示；Windows 防火墙与网络适配器信息辅助脚本可用。

- 最佳实践
  - 优先事件驱动（信号槽）替代定时轮询；必要时才全局代理，默认优先 per-app。
  - SQLite 持久化（accounts.db）集中管理账户、限制与健康状态。
  - 与浏览器自动化解耦：GUI 主流程无需浏览器，注册链路可插拔。

- 后续优化
  - 统一 toast 与错误码映射；Warp.exe 路径可配置；代理 allowlist/blacklist UI 化；账号健康度打分；自动化测试补齐。
